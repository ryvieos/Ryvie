<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mise à jour en cours - Ryvie</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }

    .update-container {
      background: white;
      border-radius: 16px;
      padding: 48px;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .spinner {
      width: 64px;
      height: 64px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #1a202c;
    }

    .message {
      font-size: 14px;
      color: #718096;
      margin-bottom: 24px;
      line-height: 1.6;
      min-height: 40px;
    }

    .version {
      display: inline-block;
      background: #f7fafc;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      color: #4a5568;
      margin-bottom: 24px;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: #667eea;
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 5%;
    }

    .progress-text {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
    }

    .success-icon {
      display: none;
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      background: #48bb78;
      border-radius: 50%;
      position: relative;
    }

    .success-icon::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 32px;
      font-weight: bold;
    }

    .error-icon {
      display: none;
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      background: #f56565;
      border-radius: 50%;
      position: relative;
    }

    .error-icon::after {
      content: '✕';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 32px;
      font-weight: bold;
    }

    .step-indicator {
      font-size: 12px;
      color: #a0aec0;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="server-data" data-return-url="__RETURN_URL__" style="display: none;"></div>
  <div class="update-container">
    <div class="spinner" id="spinner"></div>
    <div class="success-icon" id="successIcon"></div>
    <div class="error-icon" id="errorIcon"></div>
    
    <h1>Mise à jour en cours</h1>
    <div class="message" id="message">Initialisation de la mise à jour...</div>
    <div class="version" id="version">Version cible: latest</div>
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">5%</div>
    <div class="step-indicator" id="stepIndicator"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetVersion = urlParams.get('version') || 'latest';
    const accessMode = urlParams.get('mode') || 'private';
    const returnUrl = urlParams.get('return') || '/#/home';
    const originParam = urlParams.get('origin') || '';
    const serverData = document.getElementById('server-data').dataset;
    const savedReturnUrl = serverData.returnUrl || '';

    console.log('[Monitor Client] Version cible:', targetVersion);
    console.log('[Monitor Client] Mode d acces:', accessMode);
    console.log('[Monitor Client] URL de retour (param):', returnUrl);
    console.log('[Monitor Client] Origin (param):', originParam);
    console.log('[Monitor Client] URL de retour sauvegardee:', savedReturnUrl);
    
    document.getElementById('version').textContent = 'Version cible: ' + targetVersion;

    const UPDATE_DURATION = 180000; // 3 minutes en millisecondes
    const startTime = Date.now();
    let redirected = false;

    function updateProgress(progress, message, step) {
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('progressText').textContent = progress + '%';
      document.getElementById('message').textContent = message;
      if (step) {
        document.getElementById('stepIndicator').textContent = step;
      }
    }

    function getRedirectOrigin() {
      // Priorité:
      // 1) param origin (ex: http://rev.local:3000)
      // 2) origin sauvegardée dans .env (lue depuis data-attribute)
      // 3) origin actuelle de la page (ryvie.local:3005)
      if (originParam && /^https?:\/\//.test(originParam)) return originParam;
      if (savedReturnUrl && /^https?:\/\//.test(savedReturnUrl)) return savedReturnUrl;
      return window.location.origin;
    }

    function handleSuccess() {
      if (redirected) return;
      redirected = true;

      console.log("[Monitor] Mise a jour terminee, redirection imminente");
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('successIcon').style.display = 'block';
      updateProgress(100, "Mise a jour terminee. Redirection en cours...", "Termine");

      setTimeout(() => {
        const redirectOrigin = getRedirectOrigin();
        const finalUrl = redirectOrigin + returnUrl;
        console.log('[Monitor] Redirection vers:', finalUrl);
        window.location.href = finalUrl;

        setTimeout(async () => {
          try {
            await fetch('http://' + window.location.hostname + ':3001/cleanup', { method: 'POST' });
            console.log('[Monitor] Cleanup appelé');
          } catch (e) {
            console.log('[Monitor] Cleanup appelé (erreur ignorée)');
          }
        }, 2000);
      }, 2000);
    }

    function startPolling() {
      console.log("[Monitor] Démarrage du polling de statut");
      const pollingInterval = setInterval(async () => {
        try {
          const response = await fetch('/status?t=' + new Date().getTime());
          if (!response.ok) {
            // Pas d'arrêt, on continue d'essayer
            console.warn(`[Monitor] Erreur HTTP ${response.status} lors de la récupération du statut.`);
            return;
          }
          const data = await response.json();

          console.log('[Monitor] Statut reçu:', data);
          updateProgress(data.progress, data.message, data.step);

          if (data.progress >= 100) {
            clearInterval(pollingInterval);
            handleSuccess();
          }

        } catch (error) {
          console.error('[Monitor] Erreur lors du polling:', error);
        }
      }, 2000); // Poll toutes les 2 secondes

      // Sécurité: si après 3 minutes, rien ne s'est passé, on redirige quand même
      setTimeout(() => {
        if (!redirected) {
            console.warn('[Monitor] Timeout de 3 minutes atteint, redirection forcée.');
            clearInterval(pollingInterval);
            handleSuccess();
        }
      }, UPDATE_DURATION);
    }

    // Démarrer le polling
    startPolling();
  </script>
</body>
</html>
